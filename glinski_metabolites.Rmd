---
title: "glinski_metabolites"  
output: html_document
---
tested hypotheses
============
- observed vivo versus in vitro degradation rates are the same, or observed vivo rates are lower than in vitro rates (due to other degradation processes, uptake kinetics?)
- first order kinetics are michaelis-menton, second order
- are in vitro indicative of in vivo

things to do
============
- michaelis menton first order comparison for both experiments
- non-linear goodness of fit

install and load supporting libraries
======================================
```{r setup, eval=TRUE, echo=FALSE, }
print(Sys.info()[4])

#original data sources are available on dropbox
#/amphib_glinski_micosomes

#install.packages('rmarkdown')
#install.packages(dplyr)
#install.packages(knitr)
#install.packages(zoo)
#install.packages(xtable)
#install.packages(drc) # for fitting Michaelis Menten model
#install.packages(ggplot2) # for drawing
#install.packages(scatterplot3d) # for drawing
#library(grofit)

R.Version()$version.string
library(rmarkdown, quietly = TRUE, warn.conflicts = FALSE)
library(dplyr, quietly = TRUE, warn.conflicts = FALSE)
library(knitr, quietly = TRUE, warn.conflicts = FALSE)
library(zoo, quietly = TRUE, warn.conflicts = FALSE)
library(xtable, quietly = TRUE, warn.conflicts = FALSE)
library(drc, quietly = TRUE, warn.conflicts = FALSE) # for fitting Michaelis Menten model
library(ggplot2, quietly = TRUE, warn.conflicts = FALSE) # for drawing
library(scatterplot3d)
#library(grofit)
print("list of loaded packages: ")
print((.packages()))
```

import experimental exposure and microsomal data
=================================
Load csv files with experimental data and microsome data sets. The beolw may return false but still be OK if rstudio does not have privileges to data directory (e.g., attached drive).

```{r import_data, eval=TRUE, echo=FALSE}
if(Sys.info()[4]=="DONNA-PC"){
  micro.root <- path.expand("C:/Users/Donna/Documents/Github/glinski_metabolites/")
}

if(Sys.info()[4]=="stp-air-3.local" || Sys.info()[4]=="stp-air.local" || Sys.info()[4]=="stp-air"){
  micro.root <- path.expand("~/git/glinski_metabolites/")
}

if(Sys.info()[4]=="DZ2626UTPURUCKE"){
  micro.root <- "k:/git/glinski_metabolites/"
}
print(paste("Root directory location: ", micro.root, sep=""))

micro.csv.in <- paste(micro.root, "csv_in/", sep="")
micro.csv.out <- paste(micro.root, "csv_out/", sep="")
micro.graphics <- paste(micro.root, "graphics/", sep="")
micro.tables <- paste(micro.root, "tables/", sep="")

#maybe ok even if remote drive returns false
print(paste("check to see if R can access files OK: ", file.exists(micro.csv.in), sep = ""))

#import data
micro <- read.table(paste(micro.csv.in,"exposure_experiment.csv",sep=""), header = TRUE, sep = ",")
microsome <- read.table(paste(micro.csv.in,"microsome_experiment2.csv",sep=""), header = TRUE, sep = ",")

#atrazine data breakouts
microsome.atrazine <- microsome[which(microsome$parent=="atrazine"),]
microsome.atrazine.atrazine <- microsome.atrazine[which(microsome.atrazine$analyte=="atrazine"),]
microsome.atrazine.dia <- microsome.atrazine[which(microsome.atrazine$analyte=="dia"),]
microsome.atrazine.dea <- microsome.atrazine[which(microsome.atrazine$analyte=="dea"),]
#fix time zeroes for parents and daughters
microsome.atrazine.atrazine$conc[which(microsome.atrazine.atrazine$time==0)] = 
    microsome.atrazine.atrazine$microMexp[which(microsome.atrazine.atrazine$time==0)]
microsome.atrazine.dia$conc[which(microsome.atrazine.dia$time==0)] = 0
microsome.atrazine.dea$conc[which(microsome.atrazine.dea$time==0)] = 0

#triadimefon data breakouts
microsome.triadimefon <- microsome[which(microsome$parent=="triadimefon"),]
microsome.triadimefon.triadimefon <- microsome.triadimefon[which(microsome.triadimefon$analyte=="triadimefon"),]
microsome.triadimefon.tdla <- microsome.triadimefon[which(microsome.triadimefon$analyte=="tdla"),]
microsome.triadimefon.tdlb <- microsome.triadimefon[which(microsome.triadimefon$analyte=="tdlb"),]
#fix time zeroes for parents and daughters
microsome.triadimefon.triadimefon$conc[which(microsome.triadimefon.triadimefon$time==0)] = 
    microsome.triadimefon.triadimefon$microMexp[which(microsome.triadimefon.triadimefon$time==0)]
microsome.triadimefon.tdla$conc[which(microsome.triadimefon.tdla$time==0)] = 0
microsome.triadimefon.tdlb$conc[which(microsome.triadimefon.tdlb$time==0)] = 0

#fipronil data breakouts
microsome.fipronil <- microsome[which(microsome$parent=="fipronil"),]
microsome.fipronil.fipronil <- microsome.fipronil[which(microsome.fipronil$analyte=="fipronil"),]
microsome.fipronil.fipsulf <- microsome.fipronil[which(microsome.fipronil$analyte=="fipsulf"),]
#fix time zeroes for parents and daughters
microsome.fipronil.fipronil$conc[which(microsome.fipronil.fipronil$time==0)] = 
    microsome.fipronil.fipronil$microMexp[which(microsome.fipronil.fipronil$time==0)]
microsome.fipronil.fipsulf$conc[which(microsome.fipronil.fipsulf$time==0)] = 0

#drop outliers per dg
#print("outliers:")
#rowstodrop <- c(96,99,125:139)
#microsome[rowstodrop,]
#microsome <- microsome[-rowstodrop,]
#triadimefon at conc =250
#tdla at time=0, conc 0.68, replicate =3
```

experimental exposure data structure
====================================
Check out structure of imported data sets. 

```{r data_structure, eval=TRUE, echo=TRUE}
str(micro)
```

Set time and replicate fields as factors for later statistical inference.
```{r set_factors, eval=TRUE, echo=FALSE}
micro$replicate <- factor(micro$replicate)
parents <- unique(micro$parent)
analytes <- unique(micro$analyte)

#micro
#parents
#analytes

micro.amphib <- micro[which(micro$matrix=="amphib"),]
micro.soil <- micro[which(micro$matrix=="soil"),]

```

microsome experiment data structure
====================================
Check out structure of imported data set for the microsome analysis. 

```{r microsome_structure, eval=TRUE, echo=TRUE}
str(microsome)
```

Set time and replicate fields as factors for later statistical inference.
```{r microsome_factors, eval=TRUE, echo=FALSE}
microsome$replicate <- factor(microsome$replicate)
omeparents <- unique(microsome$parent)
omeanalytes <- unique(microsome$analyte)

#microsome
#omeparents
#omeanalytes

#estimate the rate

str(microsome)

```

analyze microsomal data
=================================
The microsomal experiment has 3-4 replicates for each pesticide. The experiment progressively increases the concentration of the substrate (microMexp) and measures the enzyme velocity. At each substrate concentration the reaction is quenched after a specific period of time (0, 15, 30, 60, 90 mins). This time series data is used to estimate a slope associated with each substrate concentration. Substrate concentration and linear velocity slopes are then fit using Michaelis-Menten kinetics to estimate reaction rates for each pesticide.

atrazine
=================================
```{r atrazine_mm, eval=TRUE, echo=FALSE}
#microsome.atrazine.atrazine$microMexp
Substrate <- microsome.atrazine.atrazine$microMexp
Time <- microsome.atrazine.atrazine$time
Observed <- microsome.atrazine.atrazine$conc
scatterplot3d(Substrate, Time, Observed, highlight.3d = TRUE, col.grid = "lightblue", 
              col.axis = "blue")
```

The above figure shows a three-dimensional plot of pesticide substrate concentration, observed concentration and experiment time. We need to condition the pesticide data on the substrate concentrations used in the experiment and regress the observed concentrations over the 90 min period in order to estimate the linear slopes for the Michaelis-Menten kinetic rate constants.

```{r eval=TRUE, echo=FALSE}
Substrates <- unique(Substrate)
n_substrates <- length(Substrates)
sub <- vector(mode = "numeric", length = n_substrates)
vel <- vector(mode = "numeric", length = n_substrates)
print("Substrates:")
i <- 0
for (s in Substrates){
  i <- i + 1
  print("##################################################")
  print(paste("Substrate = ", s))
  ind <- which(Substrate==s)
  print(paste("Indices = ", ind))
  print(paste("Times =", Time[ind]))
  print(paste("Concs =", Observed[ind]))
  mfit <- lm(Observed[ind] ~ Time[ind])
  print(mfit)
  print(summary(mfit))
  plot(Time[ind],Observed[ind], main = paste("Atrazine Substrate =", s))
  abline(mfit)
  print(coefficients(mfit))
  print(confint(mfit))
  sub[i] <- s
  vel[i] <- coefficients(mfit)[2] * (-1) * 1000 /0.2
  print("##################################################")
}

mm <- as.data.frame(cbind(sub,vel))
str(mm)
print(mm)

plot(vel ~ sub)
model.drm <- drm(vel ~ sub, fct = MM.2())

#redo substrate concs for plotting
mml <- data.frame(sub = seq(0, max(sub), length.out = 100))
mml$vel <- predict(model.drm, newdata = mml)

ggplot(mm, aes(x = sub, y = vel)) +
  theme_bw() +
  xlab("Concentration [uM]") +
  ylab("Velocity [pmol/min/mg protein]") +
  ggtitle("Michaelis-Menten kinetics") +
  geom_point(alpha = 0.5) +
  geom_line(data = mml, aes(x = sub, y = vel), colour = "red")
ggsave("mm_atrazine.pdf", width = 6, height = 4)
#collect slopes
#multiply by negative 1, multiple by a 1000, divide by 0.2
#x,y for mm
```

We are interested in the reaction rate, v, which is a function of available substrate (pesticide) and the presence of an enzyme. We get Vmax from the asymptote and K = 0.5*Vmax. Biochemical reactions with a single substrate are typically assumed to follow Michaelis-Menten kinetics even if they deviate from the basic model assumptions.

We are fitting the 2-parameter model. 

Used to estimate slopes.
```{r eval=TRUE, echo=FALSE}
#MM.2(c(microsome.atrazine$time, microsome$conc))
```

dea
=================================
```{r eval=TRUE, echo=FALSE}
#microsome.atrazine.atrazine$microMexp
Substrate <- microsome.atrazine.dea$microMexp
Time <- microsome.atrazine.dea$time
Observed <- microsome.atrazine.dea$conc
scatterplot3d(Substrate, Time, Observed, highlight.3d = TRUE, col.grid = "lightblue", 
              col.axis = "blue")
```

The above figure shows a three-dimensional plot of pesticide substrate concentration, observed concentration and experiment time. We need to condition the pesticide data on the substrate concentrations used in the experiment and regress the observed concentrations over the 90 min period in order to estimate the linear slopes for the Michaelis-Menten kinetic rate constants.

```{r eval=TRUE, echo=FALSE}
Substrates <- unique(Substrate)
n_substrates <- length(Substrates)
sub <- vector(mode = "numeric", length = n_substrates)
vel <- vector(mode = "numeric", length = n_substrates)
print("Substrates:")
i <- 0
for (s in Substrates){
  i <- i + 1
  print("##################################################")
  print(paste("Substrate = ", s))
  ind <- which(Substrate==s)
  print(paste("Indices = ", ind))
  print(paste("Times =", Time[ind]))
  print(paste("Concs =", Observed[ind]))
  mfit <- lm(Observed[ind] ~ Time[ind])
  print(mfit)
  print(summary(mfit))
  plot(Time[ind],Observed[ind], main = paste("DEA Substrate =", s))
  abline(mfit)
  print(coefficients(mfit))
  print(confint(mfit))
  sub[i] <- s
  vel[i] <- coefficients(mfit)[2] * (1) * 1000 /0.2
  print("##################################################")
}

mm <- as.data.frame(cbind(sub,vel))
str(mm)
print(mm)

plot(vel ~ sub)
model.drm <- drm(vel ~ sub, fct = MM.2())

#redo substrate concs for plotting
mml <- data.frame(sub = seq(0, max(sub), length.out = 100))
mml$vel <- predict(model.drm, newdata = mml)

ggplot(mm, aes(x = sub, y = vel)) +
  theme_bw() +
  xlab("Concentration [uM]") +
  ylab("Velocity [pmol/min/mg protein]") +
  ggtitle("Michaelis-Menten kinetics") +
  geom_point(alpha = 0.5) +
  geom_line(data = mml, aes(x = sub, y = vel), colour = "red")
ggsave("mm_dea.pdf", width = 6, height = 4)
#collect slopes
#multiply by negative 1, multiple by a 1000, divide by 0.2
#x,y for mm
```

We are interested in the reaction rate, v, which is a function of available substrate (pesticide) and the presence of an enzyme. We get Vmax from the asymptote and K = 0.5*Vmax. Biochemical reactions with a single substrate are typically assumed to follow Michaelis-Menten kinetics even if they deviate from the basic model assumptions.

We are fitting the 2-parameter model. 

Used to estimate slopes.
```{r eval=TRUE, echo=FALSE}
#MM.2(c(microsome.atrazine$time, microsome$conc))
```

dia
=================================
```{r eval=TRUE, echo=FALSE}
microsome.time <- microsome.atrazine.dia$time

#microsome.atrazine.atrazine$microMexp
Substrate <- microsome.atrazine.dia$microMexp
Time <- microsome.atrazine.dia$time
Observed <- microsome.atrazine.dia$conc
scatterplot3d(Substrate, Time, Observed, highlight.3d = TRUE, col.grid = "lightblue", 
              col.axis = "blue")
```

The above figure shows a three-dimensional plot of pesticide substrate concentration, observed concentration and experiment time. We need to condition the pesticide data on the substrate concentrations used in the experiment and regress the observed concentrations over the 90 min period in order to estimate the linear slopes for the Michaelis-Menten kinetic rate constants.

```{r eval=TRUE, echo=FALSE}
Substrates <- unique(Substrate)
n_substrates <- length(Substrates)
sub <- vector(mode = "numeric", length = n_substrates)
vel <- vector(mode = "numeric", length = n_substrates)
print("Substrates:")
i <- 0
for (s in Substrates){
  i <- i + 1
  print("##################################################")
  print(paste("Substrate = ", s))
  ind <- which(Substrate==s)
  print(paste("Indices = ", ind))
  print(paste("Times =", Time[ind]))
  print(paste("Concs =", Observed[ind]))
  mfit <- lm(Observed[ind] ~ Time[ind])
  print(mfit)
  print(summary(mfit))
  plot(Time[ind],Observed[ind], main = paste("DIA Substrate =", s))
  abline(mfit)
  print(coefficients(mfit))
  print(confint(mfit))
  sub[i] <- s
  vel[i] <- coefficients(mfit)[2] * (1) * 1000 /0.2
  print("##################################################")
}

mm <- as.data.frame(cbind(sub,vel))
str(mm)
print(mm)

plot(vel ~ sub)
model.drm <- drm(vel ~ sub, fct = MM.2())

#redo substrate concs for plotting
mml <- data.frame(sub = seq(0, max(sub), length.out = 100))
mml$vel <- predict(model.drm, newdata = mml)

ggplot(mm, aes(x = sub, y = vel)) +
  theme_bw() +
  xlab("Concentration [uM]") +
  ylab("Velocity [pmol/min/mg protein]") +
  ggtitle("Michaelis-Menten kinetics") +
  geom_point(alpha = 0.5) +
  geom_line(data = mml, aes(x = sub, y = vel), colour = "red")
ggsave("mm_dia.pdf", width = 6, height = 4)
#collect slopes
#multiply by negative 1, multiple by a 1000, divide by 0.2
#x,y for mm
```

triadimefon
=================================
```{r eval=TRUE, echo=FALSE}
#microsome.atrazine.atrazine$microMexp
Substrate <- microsome.triadimefon.triadimefon$microMexp
Time <- microsome.triadimefon.triadimefon$time
Observed <- microsome.triadimefon.triadimefon$conc
scatterplot3d(Substrate, Time, Observed, highlight.3d = TRUE, col.grid = "lightblue", 
              col.axis = "blue")
```

The above figure shows a three-dimensional plot of pesticide substrate concentration, observed concentration and experiment time. We need to condition the pesticide data on the substrate concentrations used in the experiment and regress the observed concentrations over the 90 min period in order to estimate the linear slopes for the Michaelis-Menten kinetic rate constants.

```{r eval=TRUE, echo=FALSE}
Substrates <- unique(Substrate)
n_substrates <- length(Substrates)
sub <- vector(mode = "numeric", length = n_substrates)
vel <- vector(mode = "numeric", length = n_substrates)
print("Substrates:")
i <- 0
for (s in Substrates){
  i <- i + 1
  print("##################################################")
  print(paste("Substrate = ", s))
  ind <- which(Substrate==s)
  print(paste("Indices = ", ind))
  print(paste("Times =", Time[ind]))
  print(paste("Concs =", Observed[ind]))
  mfit <- lm(Observed[ind] ~ Time[ind])
  print(mfit)
  print(summary(mfit))
  plot(Time[ind],Observed[ind], main = paste("Triadimefon Substrate =", s))
  abline(mfit)
  print(coefficients(mfit))
  print(confint(mfit))
  sub[i] <- s
  vel[i] <- coefficients(mfit)[2] * (-1) * 1000 /0.2
  print("##################################################")
}

mm <- as.data.frame(cbind(sub,vel))
str(mm)
print(mm)

plot(vel ~ sub)
model.drm <- drm(vel ~ sub, fct = MM.2())

#redo substrate concs for plotting
mml <- data.frame(sub = seq(0, max(sub), length.out = 100))
mml$vel <- predict(model.drm, newdata = mml)

ggplot(mm, aes(x = sub, y = vel)) +
  theme_bw() +
  xlab("Concentration [uM]") +
  ylab("Velocity [pmol/min/mg protein]") +
  ggtitle("Michaelis-Menten kinetics") +
  geom_point(alpha = 0.5) +
  geom_line(data = mml, aes(x = sub, y = vel), colour = "red")
ggsave("mm_triadimefon.pdf", width = 6, height = 4)
#collect slopes
#multiply by negative 1, multiple by a 1000, divide by 0.2
#x,y for mm
```

tdla
=================================
```{r eval=TRUE, echo=FALSE}
#microsome.atrazine.atrazine$microMexp
Substrate <- microsome.triadimefon.tdla$microMexp
Time <- microsome.triadimefon.tdla$time
Observed <- microsome.triadimefon.tdla$conc
scatterplot3d(Substrate, Time, Observed, highlight.3d = TRUE, col.grid = "lightblue", 
              col.axis = "blue")
```

The above figure shows a three-dimensional plot of pesticide substrate concentration, observed concentration and experiment time. We need to condition the pesticide data on the substrate concentrations used in the experiment and regress the observed concentrations over the 90 min period in order to estimate the linear slopes for the Michaelis-Menten kinetic rate constants.

```{r eval=TRUE, echo=FALSE}
Substrates <- unique(Substrate)
n_substrates <- length(Substrates)
sub <- vector(mode = "numeric", length = n_substrates)
vel <- vector(mode = "numeric", length = n_substrates)
print("Substrates:")
i <- 0
for (s in Substrates){
  i <- i + 1
  print("##################################################")
  print(paste("Substrate = ", s))
  ind <- which(Substrate==s)
  print(paste("Indices = ", ind))
  print(paste("Times =", Time[ind]))
  print(paste("Concs =", Observed[ind]))
  mfit <- lm(Observed[ind] ~ Time[ind])
  print(mfit)
  print(summary(mfit))
  plot(Time[ind],Observed[ind], main = paste("tdla Substrate =", s))
  abline(mfit)
  print(coefficients(mfit))
  print(confint(mfit))
  sub[i] <- s
  vel[i] <- coefficients(mfit)[2] * (1) * 1000 /0.2
  print("##################################################")
}

mm <- as.data.frame(cbind(sub,vel))
str(mm)
print(mm)

plot(vel ~ sub)
model.drm <- drm(vel ~ sub, fct = MM.2())

#redo substrate concs for plotting
mml <- data.frame(sub = seq(0, max(sub), length.out = 100))
mml$vel <- predict(model.drm, newdata = mml)

ggplot(mm, aes(x = sub, y = vel)) +
  theme_bw() +
  xlab("Concentration [uM]") +
  ylab("Velocity [pmol/min/mg protein]") +
  ggtitle("Michaelis-Menten kinetics") +
  geom_point(alpha = 0.5) +
  geom_line(data = mml, aes(x = sub, y = vel), colour = "red")
ggsave("mm_tdla.pdf", width = 6, height = 4)
#collect slopes
#multiply by negative 1, multiple by a 1000, divide by 0.2
#x,y for mm
```

tdlb
=================================
```{r eval=TRUE, echo=FALSE}
#microsome.atrazine.atrazine$microMexp
Substrate <- microsome.triadimefon.tdlb$microMexp
Time <- microsome.triadimefon.tdlb$time
Observed <- microsome.triadimefon.tdlb$conc
scatterplot3d(Substrate, Time, Observed, highlight.3d = TRUE, col.grid = "lightblue", 
              col.axis = "blue")
```

The above figure shows a three-dimensional plot of pesticide substrate concentration, observed concentration and experiment time. We need to condition the pesticide data on the substrate concentrations used in the experiment and regress the observed concentrations over the 90 min period in order to estimate the linear slopes for the Michaelis-Menten kinetic rate constants.

```{r eval=TRUE, echo=FALSE}
Substrates <- unique(Substrate)
n_substrates <- length(Substrates)
sub <- vector(mode = "numeric", length = n_substrates)
vel <- vector(mode = "numeric", length = n_substrates)
print("Substrates:")
i <- 0
for (s in Substrates){
  i <- i + 1
  print("##################################################")
  print(paste("Substrate = ", s))
  ind <- which(Substrate==s)
  print(paste("Indices = ", ind))
  print(paste("Times =", Time[ind]))
  print(paste("Concs =", Observed[ind]))
  mfit <- lm(Observed[ind] ~ Time[ind])
  print(mfit)
  print(summary(mfit))
  plot(Time[ind],Observed[ind], main = paste("tdlb Substrate =", s))
  abline(mfit)
  print(coefficients(mfit))
  print(confint(mfit))
  sub[i] <- s
  vel[i] <- coefficients(mfit)[2] * (1) * 1000 /0.2
  print("##################################################")
}

mm <- as.data.frame(cbind(sub,vel))
str(mm)
print(mm)

plot(vel ~ sub)
model.drm <- drm(vel ~ sub, fct = MM.2())

#redo substrate concs for plotting
mml <- data.frame(sub = seq(0, max(sub), length.out = 100))
mml$vel <- predict(model.drm, newdata = mml)

ggplot(mm, aes(x = sub, y = vel)) +
  theme_bw() +
  xlab("Concentration [uM]") +
  ylab("Velocity [pmol/min/mg protein]") +
  ggtitle("Michaelis-Menten kinetics") +
  geom_point(alpha = 0.5) +
  geom_line(data = mml, aes(x = sub, y = vel), colour = "red")
ggsave("mm_tdlb.pdf", width = 6, height = 4)
#collect slopes
#multiply by negative 1, multiple by a 1000, divide by 0.2
#x,y for mm
```

fipronil
=================================
```{r eval=TRUE, echo=FALSE}
#microsome.atrazine.atrazine$microMexp
Substrate <- microsome.fipronil.fipronil$microMexp
Time <- microsome.fipronil.fipronil$time
Observed <- microsome.fipronil.fipronil$conc
scatterplot3d(Substrate, Time, Observed, highlight.3d = TRUE, col.grid = "lightblue", 
              col.axis = "blue")
```

The above figure shows a three-dimensional plot of pesticide substrate concentration, observed concentration and experiment time. We need to condition the pesticide data on the substrate concentrations used in the experiment and regress the observed concentrations over the 90 min period in order to estimate the linear slopes for the Michaelis-Menten kinetic rate constants.

```{r eval=TRUE, echo=FALSE}
Substrates <- unique(Substrate)
n_substrates <- length(Substrates)
sub <- vector(mode = "numeric", length = n_substrates)
vel <- vector(mode = "numeric", length = n_substrates)
print("Substrates:")
i <- 0
for (s in Substrates){
  i <- i + 1
  print("##################################################")
  print(paste("Substrate = ", s))
  ind <- which(Substrate==s)
  print(paste("Indices = ", ind))
  print(paste("Times =", Time[ind]))
  print(paste("Concs =", Observed[ind]))
  mfit <- lm(Observed[ind] ~ Time[ind])
  print(mfit)
  print(summary(mfit))
  plot(Time[ind],Observed[ind], main = paste("Fipronil Substrate =", s))
  abline(mfit)
  print(coefficients(mfit))
  print(confint(mfit))
  sub[i] <- s
  vel[i] <- coefficients(mfit)[2] * (-1) * 1000 /0.2
  print("##################################################")
}

mm <- as.data.frame(cbind(sub,vel))
str(mm)
print(mm)

plot(vel ~ sub)
model.drm <- drm(vel ~ sub, fct = MM.2())

#redo substrate concs for plotting
mml <- data.frame(sub = seq(0, max(sub), length.out = 100))
mml$vel <- predict(model.drm, newdata = mml)

ggplot(mm, aes(x = sub, y = vel)) +
  theme_bw() +
  xlab("Concentration [uM]") +
  ylab("Velocity [pmol/min/mg protein]") +
  ggtitle("Michaelis-Menten kinetics") +
  geom_point(alpha = 0.5) +
  geom_line(data = mml, aes(x = sub, y = vel), colour = "red")
ggsave("mm_fipronil.pdf", width = 6, height = 4)
#collect slopes
#multiply by negative 1, multiple by a 1000, divide by 0.2
#x,y for mm
```

fipsulf
=================================
```{r eval=TRUE, echo=FALSE}
#microsome.atrazine.atrazine$microMexp
Substrate <- microsome.fipronil.fipsulf$microMexp
Time <- microsome.fipronil.fipsulf$time
Observed <- microsome.fipronil.fipsulf$conc
scatterplot3d(Substrate, Time, Observed, highlight.3d = TRUE, col.grid = "lightblue", 
              col.axis = "blue")
```

The above figure shows a three-dimensional plot of pesticide substrate concentration, observed concentration and experiment time. We need to condition the pesticide data on the substrate concentrations used in the experiment and regress the observed concentrations over the 90 min period in order to estimate the linear slopes for the Michaelis-Menten kinetic rate constants.

```{r eval=TRUE, echo=FALSE}
Substrates <- unique(Substrate)
n_substrates <- length(Substrates)
sub <- vector(mode = "numeric", length = n_substrates)
vel <- vector(mode = "numeric", length = n_substrates)
print("Substrates:")
i <- 0
for (s in Substrates){
  i <- i + 1
  print("##################################################")
  print(paste("Substrate = ", s))
  ind <- which(Substrate==s)
  print(paste("Indices = ", ind))
  print(paste("Times =", Time[ind]))
  print(paste("Concs =", Observed[ind]))
  mfit <- lm(Observed[ind] ~ Time[ind])
  print(mfit)
  print(summary(mfit))
  plot(Time[ind],Observed[ind], main = paste("fipsulf Substrate =", s))
  abline(mfit)
  print(coefficients(mfit))
  print(confint(mfit))
  sub[i] <- s
  vel[i] <- coefficients(mfit)[2] * (1) * 1000 /0.2
  print("##################################################")
}

mm <- as.data.frame(cbind(sub,vel))
str(mm)
print(mm)

plot(vel ~ sub)
model.drm <- drm(vel ~ sub, fct = MM.2())

#redo substrate concs for plotting
mml <- data.frame(sub = seq(0, max(sub), length.out = 100))
mml$vel <- predict(model.drm, newdata = mml)

ggplot(mm, aes(x = sub, y = vel)) +
  theme_bw() +
  xlab("Concentration [uM]") +
  ylab("Velocity [pmol/min/mg protein]") +
  ggtitle("Michaelis-Menten kinetics") +
  geom_point(alpha = 0.5) +
  geom_line(data = mml, aes(x = sub, y = vel), colour = "red")
ggsave("mm_fipsulf.pdf", width = 6, height = 4)
#collect slopes
#multiply by negative 1, multiple by a 1000, divide by 0.2
#x,y for mm
```

exposure experiment analysis
============================
Results presentation and discussion for parent analytes (atrazine, triadimenon, and fipronil) and their xenobiotic metabolites.

Toxicity of parents and metabolites discussion.

Microsomal analysis of soil and amphibian data for 0 (soil only), 2, 4, 12, 24, and 48 hours after exposure.

Database has factors for time, parent (mapped to analyte), analyte (can be either parent or metabolite), matrix (amphibian or soil), and tank (potentially a nuisance variable).

```{r eval=TRUE, echo=FALSE}
#using dplyr
micro.group <- group_by(micro, parent, analyte, matrix, time)
str(micro.group)
micro.group
micro.group.stats <- summarise(micro.group, 
            count = n(),
            ConcMean = mean(conc),
            ConcSD = sd(conc)
)

micro.group.stats
micro.group.stats.html <- print.xtable(xtable(micro.group.stats), type="html")
dput(micro.group.stats.html, file = paste(micro.tables,"micro.group.stats.html"
                                          ,sep=""))
#View(micro.group.stats)
```

The amphibian data set summary statistics. Atrazine peaks at 4 hours and then declines monotonically. DEA peaks at 12 hours and DIA at 24. Fipronil steadily declines from its first observation at 2 hours with fipronil sulfone not peaking until 24 hours. Triadimenon peaks at 24 hours with its metabolites tdla and tdlb peaking at 4 hours.

```{r eval=TRUE, echo=FALSE}
str(micro.group.stats)
micro.group.stats.amphib <- micro.group.stats[which(micro.group.stats$matrix=="amphib"),]
head(micro.group.stats.amphib)
#atrazine
micro.group.stats.amphib.atrazine <- micro.group.stats.amphib[which(micro.group.stats.amphib$parent=="atrazine"),]
micro.group.stats.amphib.atrazine
atrazine.analytes <- unique(micro.group.stats.amphib.atrazine$analyte)
for(analyte in atrazine.analytes){
  print(analyte)
}

#fipronil
micro.group.stats.amphib.fipronil <- micro.group.stats.amphib[which(micro.group.stats.amphib$parent=="fipronil"),]
micro.group.stats.amphib.fipronil
#triadimenon
micro.group.stats.amphib.triadimenon <- micro.group.stats.amphib[which(micro.group.stats.amphib$parent=="triadimenon"),]
micro.group.stats.amphib.triadimenon
```

```{r eval=TRUE, echo=FALSE}
#plot with zoo objects
```

The soil data set summary statistics. Atrazine in soil showing an upwards trend (need to test if significant) with dia and dea levels very low indicating little degradation in soil over the 48 hour period. Fipronil and triadimenon data also indicating little degradation in soil. 

```{r eval=TRUE, echo=FALSE}
micro.group.stats.soil <- micro.group.stats[which(micro.group.stats$matrix=="soil"),]
#atrazine
micro.group.stats.soil.atrazine <- micro.group.stats.soil[which(micro.group.stats.soil$parent=="atrazine"),]
micro.group.stats.soil.atrazine
#fipronil
micro.group.stats.soil.fipronil <- micro.group.stats.soil[which(micro.group.stats.soil$parent=="fipronil"),]
micro.group.stats.soil.fipronil
#triadimenon
micro.group.stats.soil.triadimenon <- micro.group.stats.soil[which(micro.group.stats.soil$parent=="triadimenon"),]
micro.group.stats.soil.triadimenon
```



```{r eval=TRUE, echo=TRUE}
pdf(paste(micro.graphics,"data_mean_scatterplot",".pdf", sep=""))
  par(mfrow=c(3,1))
  print(parents)
  for(parent in parents){
    i=0
    print(parent)
    temp.parent <- micro.group.stats.amphib[which(micro.group.stats.amphib$parent==parent),]
    print(temp.parent)
    parent.analytes <- unique(temp.parent$analyte)
    for(analyte in parent.analytes){
      print(parent)
      print(analyte) 
      analytetemp <- micro.group.stats.amphib[which(micro.group.stats.amphib$analyte==analyte),]
      xvalues <- as.numeric(as.character(analytetemp$time))
      points.y <- micro.amphib[which(micro.amphib$analyte==analyte),]$conc
      points.x <- as.numeric(as.character(micro.amphib[which(micro.amphib$analyte==analyte),]$time))
      #create empty plot if needed
      if(i==0){
        parenttemp <- micro.group.stats.amphib[which(micro.group.stats.amphib$parent==parent),]
        maxconc <- max(points.y) 
        plot(xvalues,analytetemp$ConcMean,type="l", xlim=c(0,48),
             ylim = c(0,maxconc), main=parent,col="black", xlab="Hours", ylab="Concentration")
        axis(1,at=xvalues)
        i=1
      }
      #add line for parent metabolite
      if(analyte %in% parents){
        lines(xvalues,analytetemp$ConcMean,type="l",col="red")
        points(points.x, points.y, col = "red")
      }else{
      #add line for daughter metabolite
        lines(xvalues,analytetemp$ConcMean,type="l",col="blue")
        points(points.x, points.y, col = "blue")
      }
    }
  }
dev.off()
```

la de da

#turn times series to zoo objects



#estimate lambdas using maximum likelihood for each time series
library(maxLik)

MLexp <- function(times, data){
  
  expLik <- function(param) {
    y <- data
    t <- times
    alpha1 <- param[1]
    lambda1 <- param[2]-1*(alpha1-lambda1*t) - y/(exp(alpha1-lambda1*t))
  }
  
  max.fit <- maxLik(expLik, start = c(1,1))
  crit <- qt(.975, length(data)-2)
  max.intercept.CI <- c(summary(max.fit)$est[1,1]-crit*summary(max.fit)$est[1,2],summary(max.fit)$est[1,1]+crit*summary(max.fit)$est[1,2])
  max.decayrate.CI <- c(-1*summary(max.fit)$est[2,1]-crit*summary(max.fit)$est[2,2],-1*summary(max.fit)$est[2,1]+crit*summary(max.fit)$est[2,2])
  max.halflife.CI <- c(log(2)/max.decayrate.CI[2],log(2)/max.decayrate.CI[1])
  
  paste("MLE for Initial Concentration =",max.fit$est[1],
        "MLE for decay rate =", max.fit$est[2],
        "MLE for half life =", -log(.5)/max.fit$est[2])
  
  temp.list <- list(max.fit$est[1],  max.fit$est[2], -log(.5)/max.fit$est[2], max.intercept.CI, max.decayrate.CI, max.halflife.CI, vcov(max.fit) )
  return(temp.list)
}

MLexp.intercept <- function(times, data) {
  temp.fit <- MLexp(times,data)
  temp.fit[[1]]
}

MLexp.decayrate <- function(times, data) {
  temp.fit <- MLexp(times,data)
  temp.fit[[2]]
}

MLexp.halflife <- function(times,data) {
  temp.fit <- MLexp(times,data)
  temp.fit[[3]]
}

MLexp.intercept.CI <- function(times,data){
  temp.fit <- MLexp(times,data)
  temp2 <- temp.fit[[4]]
  names(temp2) <- c("Lower95", "Upper95")
  temp2
}

MLexp.decayrate.CI <- function(times,data){
  temp.fit <- MLexp(times,data)
  temp2 <- temp.fit[[5]]
  names(temp2) <- c("Lower95", "Upper95")
  temp2
}

MLexp.halflife.CI <- function(times,data){
  temp.fit <- MLexp(times,data)
  temp2 <- temp.fit[[6]]
  names(temp2) <- c("Lower95", "Upper95")
  temp2
}

microsome experiment analysis
============================
data in csv format