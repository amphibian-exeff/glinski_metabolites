---
title: "glinski_metabolites"  
output: html_document
---
tested hypotheses
============
- observed vivo versus in vitro degradation rates are the same, or observed vivo rates are lower than in vitro rates (due to other degradation processes, uptake kinetics?)
- first order kinetics are michaelis-menton, second order
- are in vitro indicative of in vivo

things to do
============
- michaelis menton first order comparison for both experiments
- non-linear goodness of fit

install and load supporting libraries
======================================
```{r setup, eval=TRUE, echo=FALSE, }
verbose_output = FALSE

if(verbose_output){
  print(Sys.info()[4])
  R.Version()$version.string
}

#original data sources are available on dropbox
#/amphib_glinski_micosomes

#install.packages('rmarkdown')
#install.packages(dplyr)
#install.packages(knitr)
#install.packages(zoo)
#install.packages(xtable)
#install.packages(drc, dependencies=TRUE) # for fitting Michaelis Menten model
#install.packages(ggplot2) # for drawing
#install.packages(scatterplot3d) # for drawing
#install.packages(pbkrtest)
#library(grofit)

library(rmarkdown, quietly = TRUE, warn.conflicts = FALSE)
library(dplyr, quietly = TRUE, warn.conflicts = FALSE)
library(knitr, quietly = TRUE, warn.conflicts = FALSE)
library(zoo, quietly = TRUE, warn.conflicts = FALSE)
library(xtable, quietly = TRUE, warn.conflicts = FALSE)
library(drc, quietly = TRUE, warn.conflicts = FALSE) # for fitting Michaelis Menten model
library(ggplot2, quietly = TRUE, warn.conflicts = FALSE) # for drawing
library(scatterplot3d)
library(pbkrtest)

#library(grofit)
if(verbose_output){
  print("list of loaded packages: ")
  print((.packages()))
}
```

import experimental exposure and microsomal data
=================================
Load csv files with experimental data and microsome data sets. The beolw may return false but still be OK if rstudio does not have privileges to data directory (e.g., attached drive).

```{r import_data, eval=TRUE, echo=FALSE}
if(Sys.info()[4]=="DONNA-PC"){
  micro.root <- path.expand("C:/Users/Donna/Documents/Github/glinski_metabolites/")
}

if(Sys.info()[4]=="stp-air-3.local" || Sys.info()[4]=="stp-air.local" || Sys.info()[4]=="stp-air"){
  micro.root <- path.expand("~/git/glinski_metabolites/")
}

if(Sys.info()[4]=="DZ2626UTPURUCKE"){
  micro.root <- "k:/git/glinski_metabolites/"
}

if(verbose_output){
  print(paste("Root directory location: ", micro.root, sep=""))
}

micro.csv.in <- paste(micro.root, "csv_in/", sep="")
micro.csv.out <- paste(micro.root, "csv_out/", sep="")
micro.graphics <- paste(micro.root, "graphics/", sep="")
micro.tables <- paste(micro.root, "tables/", sep="")

#maybe ok even if remote drive returns false
if(verbose_output){
  print(paste("check to see if R can access files OK: ", file.exists(micro.csv.in), sep = ""))
}

#import data
micro <- read.table(paste(micro.csv.in,"exposure_experiment.csv",sep=""), header = TRUE, sep = ",")
microsome <- read.table(paste(micro.csv.in,"microsome_experiment3.csv",sep=""), header = TRUE, sep = ",")

#drop outliers per dg
#print("outliers:")
#View(microsome)
rowstodrop <- c(4,47,61,92,95,98,101,104,127,134,169,206,209,212,215,231,235,255,259,344,347,
                350,353,356,359,365,366,370,372,379,386,478,547,591,635,657,668,710,713,803,
                927,936,1023)
microsome[rowstodrop,]
microsome <- microsome[-rowstodrop,]
#triadimefon at conc =250
#tdla at time=0, conc 0.68, replicate =3

#atrazine data breakouts
microsome.atrazine <- microsome[which(microsome$parent=="atrazine"),]
microsome.atrazine.atrazine <- microsome.atrazine[which(microsome.atrazine$analyte=="atrazine"),]
microsome.atrazine.dia <- microsome.atrazine[which(microsome.atrazine$analyte=="dia"),]
microsome.atrazine.dea <- microsome.atrazine[which(microsome.atrazine$analyte=="dea"),]
#fix time zeroes for parents and daughters
#microsome.atrazine.atrazine$conc[which(microsome.atrazine.atrazine$time==0)] = 
#    microsome.atrazine.atrazine$microMexp[which(microsome.atrazine.atrazine$time==0)]
#microsome.atrazine.dia$conc[which(microsome.atrazine.dia$time==0)] = 0
#microsome.atrazine.dea$conc[which(microsome.atrazine.dea$time==0)] = 0

#triadimefon data breakouts
microsome.triadimefon <- microsome[which(microsome$parent=="triadimefon"),]
microsome.triadimefon.triadimefon <- microsome.triadimefon[which(microsome.triadimefon$analyte=="triadimefon"),]
microsome.triadimefon.tdla <- microsome.triadimefon[which(microsome.triadimefon$analyte=="tdla"),]
microsome.triadimefon.tdlb <- microsome.triadimefon[which(microsome.triadimefon$analyte=="tdlb"),]
#fix time zeroes for parents and daughters
#microsome.triadimefon.triadimefon$conc[which(microsome.triadimefon.triadimefon$time==0)] = 
#microsome.triadimefon.triadimefon$microMexp[which(microsome.triadimefon.triadimefon$time==0)]
#microsome.triadimefon.tdla$conc[which(microsome.triadimefon.tdla$time==0)] = 0
#microsome.triadimefon.tdlb$conc[which(microsome.triadimefon.tdlb$time==0)] = 0

#fipronil data breakouts
microsome.fipronil <- microsome[which(microsome$parent=="fipronil"),]
microsome.fipronil.fipronil <- microsome.fipronil[which(microsome.fipronil$analyte=="fipronil"),]
microsome.fipronil.fipsulf <- microsome.fipronil[which(microsome.fipronil$analyte=="fipsulf"),]
#fix time zeroes for parents and daughters
#microsome.fipronil.fipronil$conc[which(microsome.fipronil.fipronil$time==0)] = 
#microsome.fipronil.fipronil$microMexp[which(microsome.fipronil.fipronil$time==0)]
#microsome.fipronil.fipsulf$conc[which(microsome.fipronil.fipsulf$time==0)] = 0

```

experimental exposure data structure
====================================
Check out structure of imported data sets. 

```{r data_structure, eval=TRUE, echo=FALSE}
if(verbose_output){
  str(micro)
}
```

Set time and replicate fields as factors for later statistical inference.
```{r set_factors, eval=TRUE, echo=FALSE}
micro$replicate <- factor(micro$replicate)
parents <- unique(micro$parent)
analytes <- unique(micro$analyte)

#micro
#parents
#analytes

micro.amphib <- micro[which(micro$matrix=="amphib"),]
micro.soil <- micro[which(micro$matrix=="soil"),]

```

microsome experiment data structure
====================================
Check out structure of imported data set for the microsome analysis. 

```{r microsome_structure, eval=TRUE, echo=FALSE}
if(verbose_output){
  str(microsome)
}
```

Set time and replicate fields as factors for later statistical inference.
```{r microsome_factors, eval=TRUE, echo=FALSE}
microsome$replicate <- factor(microsome$replicate)
omeparents <- unique(microsome$parent)
omeanalytes <- unique(microsome$analyte)

#microsome
#omeparents
#omeanalytes

#estimate the rate
if(verbose_output){
  str(microsome)
}

```

analyze microsomal data
=================================
The microsomal experiment has 3-4 replicates for each pesticide. The experiment progressively increases the concentration of the substrate (microMexp) and measures the enzyme velocity. At each substrate concentration the reaction is quenched after a specific period of time (0, 15, 30, 60, 90 mins). This time series data is used to estimate a slope associated with each substrate concentration. Substrate concentration and linear velocity slopes are then fit using Michaelis-Menten kinetics to estimate reaction rates for each pesticide.

non-linear fitting
==================
We use the dose-response model (drm) package from R for the fitting of the rate constant. We provide it the 2-parameter Michaelis-Menton function (mm2) as an argument. It uses the MM.2 function that is in the drc package and therefore is a drc object that contains a list of class drcMean, containing the mean function, the self starter function, the parameter names
and other components such as derivatives and a function for calculating ED values. It is not shifted (??) so uses the fit f(x,(c,d,e)) = c + (d-c)/(1+e/x). Where x is the dose, it is a strictly increasing function so we reverse the sign of the slopes for the parents. e is the dose halfway between c and d, for the 2-parameter model c = 0.

```{r mm_function, eval=TRUE, echo=FALSE}
getMeanFunctions(fname = "MM.2")
```

atrazine
=================================
```{r atrazine_mm, eval=TRUE, echo=FALSE}
#microsome.atrazine.atrazine$microMexp
Substrate <- microsome.atrazine.atrazine$microMexp
Time <- microsome.atrazine.atrazine$time
Observed <- microsome.atrazine.atrazine$conc
if(verbose_output){
  scatterplot3d(Substrate, Time, Observed, highlight.3d = TRUE, col.grid = "lightblue", 
                col.axis = "blue")
}
```

The above figure shows a three-dimensional plot of pesticide substrate concentration, observed concentration and experiment time. We need to condition the pesticide data on the substrate concentrations used in the experiment and regress the observed concentrations over the 90 min period in order to estimate the linear slopes for the Michaelis-Menten kinetic rate constants.

```{r atrazine_plots, eval=TRUE, echo=FALSE}
Substrates <- unique(Substrate)
n_substrates <- length(Substrates)
sub <- vector(mode = "numeric", length = n_substrates)
vel <- vector(mode = "numeric", length = n_substrates)
print("Substrates:")
i <- 0
for (s in Substrates){
  i <- i + 1
  if(verbose_output){
    print("##################################################")
    print(paste("Substrate = ", s))
  }
  ind <- which(Substrate==s)
  if(verbose_output){
    print(cbind(ind, Time[ind], Observed[ind]))
  }
  #linear regressions
  if(verbose_output){
    print(paste("least squares linear regression for substrate =", s))
  }
  lmfit <- lm(Observed[ind] ~ Time[ind])
  if(verbose_output){
    print(lmfit)
    print(summary(lmfit))
    print(coefficients(lmfit))
    print(confint(lmfit))
    par(mfrow = c(2,2), oma = c(0, 0, 1.1, 0))
    plot(lmfit, las = 1)
    #robust regression
    print(paste("weighted linear regression for substrate =", s))
    par(mfrow = c(1,1), oma = c(0, 0, 1.1, 0))
  }
  mfit <- rlm(Observed[ind] ~ Time[ind])
  if(verbose_output){
    print(mfit)
    print(summary(mfit))
  }
  plot(Time[ind],Observed[ind], main = paste("Atrazine Substrate =", s))
  text(Time[ind], Observed[ind], labels=ind, cex= 0.8, pos=4)
  abline(mfit)
  if(verbose_output){
    print(coefficients(mfit))
    print(confint(mfit))
  }
  sub[i] <- s
  vel[i] <- coefficients(mfit)[2] * (-1) * 1000 /0.2
  if(verbose_output){
    print("##################################################")
  }
}

mm.atrazine <- as.data.frame(cbind(sub,vel))
if(verbose_output){
  str(mm.atrazine)
  print(mm.atrazine)
}

#plot(vel ~ sub)
model.atrazine.drm <- drm(vel ~ sub, fct = MM.2())
print("here are the rates")
print(summary(model.atrazine.drm))

#redo substrate concs for plotting
mml.atrazine <- data.frame(sub = seq(0, max(sub), length.out = 100))
mml.atrazine$vel <- predict(model.atrazine.drm, newdata = mml.atrazine)

ggplot(mm.atrazine, aes(x = sub, y = vel)) +
  theme_bw() +
  xlab("Concentration [uM]") +
  ylab("Velocity [pmol/min/mg protein]") +
  ggtitle("Michaelis-Menten kinetics") +
  geom_point(alpha = 0.5) +
  geom_line(data = mml.atrazine, aes(x = sub, y = vel), colour = "red")
ggsave("mm_atrazine.pdf", width = 6, height = 4)
#collect slopes
#multiply by negative 1, multiple by a 1000, divide by 0.2
#x,y for mm
```

We are interested in the reaction rate, v, which is a function of available substrate (pesticide) and the presence of an enzyme. We get Vmax from the asymptote and K = 0.5*Vmax. Biochemical reactions with a single substrate are typically assumed to follow Michaelis-Menten kinetics even if they deviate from the basic model assumptions.

We are fitting the 2-parameter model. 

Used to estimate slopes.
```{r nada, eval=TRUE, echo=FALSE}
#MM.2(c(microsome.atrazine$time, microsome$conc))
```

dea
=================================
```{r dea_setup, eval=TRUE, echo=FALSE}
#microsome.atrazine.atrazine$microMexp
Substrate <- microsome.atrazine.dea$microMexp
Time <- microsome.atrazine.dea$time
Observed <- microsome.atrazine.dea$conc
if(verbose_output){
  scatterplot3d(Substrate, Time, Observed, highlight.3d = TRUE, col.grid = "lightblue", 
                col.axis = "blue")
}
```

The above figure shows a three-dimensional plot of pesticide substrate concentration, observed concentration and experiment time. We need to condition the pesticide data on the substrate concentrations used in the experiment and regress the observed concentrations over the 90 min period in order to estimate the linear slopes for the Michaelis-Menten kinetic rate constants.

```{r dea_plots, eval=TRUE, echo=FALSE}
Substrates <- unique(Substrate)
n_substrates <- length(Substrates)
sub <- vector(mode = "numeric", length = n_substrates)
vel <- vector(mode = "numeric", length = n_substrates)
print("Substrates:")
i <- 0
for (s in Substrates){
  i <- i + 1
  if(verbose_output){
    print("##################################################")
    print(paste("Substrate = ", s))
  }
  ind <- which(Substrate==s)
  if(verbose_output){
    print(paste("Indices = ", ind))
    print(paste("Times =", Time[ind]))
    print(paste("Concs =", Observed[ind]))
  }
  mfit <- rlm(Observed[ind] ~ Time[ind])
  if(verbose_output){
    print(mfit)
    print(summary(mfit))
  }
  plot(Time[ind],Observed[ind], main = paste("DEA Substrate =", s))
  text(Time[ind], Observed[ind], labels=ind, cex= 0.8, pos=4)
  abline(mfit)
  if(verbose_output){
    print(coefficients(mfit))
    print(confint(mfit))
  }
  sub[i] <- s
  vel[i] <- coefficients(mfit)[2] * 1000 /0.2
  if(verbose_output){
    print("##################################################")
  }
}

mm.dea <- as.data.frame(cbind(sub,vel))
if(verbose_output){
  str(mm.dea)
  print(mm.dea)
}

#plot(vel ~ sub)
model.dea.drm <- drm(vel ~ sub, fct = MM.2())
print("here are the rates")
print(summary(model.dea.drm))

#redo substrate concs for plotting
mml.dea <- data.frame(sub = seq(0, max(sub), length.out = 100))
mml.dea$vel <- predict(model.dea.drm, newdata = mml.dea)

ggplot(mm.dea, aes(x = sub, y = vel)) +
  theme_bw() +
  xlab("Concentration [uM]") +
  ylab("Velocity [pmol/min/mg protein]") +
  ggtitle("Michaelis-Menten kinetics") +
  geom_point(alpha = 0.5) +
  geom_line(data = mml.dea, aes(x = sub, y = vel), colour = "red")
ggsave("mm_dea.pdf", width = 6, height = 4)
#collect slopes
#multiply by negative 1, multiple by a 1000, divide by 0.2
#x,y for mm
```

We are interested in the reaction rate, v, which is a function of available substrate (pesticide) and the presence of an enzyme. We get Vmax from the asymptote and K = 0.5*Vmax. Biochemical reactions with a single substrate are typically assumed to follow Michaelis-Menten kinetics even if they deviate from the basic model assumptions.

We are fitting the 2-parameter model. 

Used to estimate slopes.
```{r nada2, eval=TRUE, echo=FALSE}
#MM.2(c(microsome.atrazine$time, microsome$conc))
```

dia
=================================
```{r dia_setup, eval=TRUE, echo=FALSE}
microsome.time <- microsome.atrazine.dia$time

#microsome.atrazine.atrazine$microMexp
Substrate <- microsome.atrazine.dia$microMexp
Time <- microsome.atrazine.dia$time
Observed <- microsome.atrazine.dia$conc
if(verbose_output){
  scatterplot3d(Substrate, Time, Observed, highlight.3d = TRUE, col.grid = "lightblue", 
                col.axis = "blue")
}
```

The above figure shows a three-dimensional plot of pesticide substrate concentration, observed concentration and experiment time. We need to condition the pesticide data on the substrate concentrations used in the experiment and regress the observed concentrations over the 90 min period in order to estimate the linear slopes for the Michaelis-Menten kinetic rate constants.

```{r dia plots, eval=TRUE, echo=FALSE}
Substrates <- unique(Substrate)
n_substrates <- length(Substrates)
sub <- vector(mode = "numeric", length = n_substrates)
vel <- vector(mode = "numeric", length = n_substrates)
print("Substrates:")
i <- 0
for (s in Substrates){
  i <- i + 1
  if(verbose_output){
    print("##################################################")
    print(paste("Substrate = ", s))
  }
  ind <- which(Substrate==s)
  if(verbose_output){
    print(paste("Indices = ", ind))
    print(paste("Times =", Time[ind]))
    print(paste("Concs =", Observed[ind]))
  }
  mfit <- rlm(Observed[ind] ~ Time[ind])
  if(verbose_output){
    print(mfit)
    print(summary(mfit))
  }
  plot(Time[ind],Observed[ind], main = paste("DIA Substrate =", s))
  text(Time[ind], Observed[ind], labels=ind, cex= 0.8, pos=4)
  abline(mfit)
  if(verbose_output){
    print(coefficients(mfit))
    print(confint(mfit))
  }
  sub[i] <- s
  vel[i] <- coefficients(mfit)[2] * 1000 /0.2
  if(verbose_output){
    print("##################################################")
  }
}

mm.dia <- as.data.frame(cbind(sub,vel))
if(verbose_output){
  str(mm.dia)
  print(mm.dia)
}

#plot(vel ~ sub)
model.dia.drm <- drm(vel ~ sub, fct = MM.2())
print("here are the rates")
print(summary(model.dia.drm))

#redo substrate concs for plotting
mml.dia <- data.frame(sub = seq(0, max(sub), length.out = 100))
mml.dia$vel <- predict(model.dia.drm, newdata = mml.dia)

ggplot(mm.dia, aes(x = sub, y = vel)) +
  theme_bw() +
  xlab("Concentration [uM]") +
  ylab("Velocity [pmol/min/mg protein]") +
  ggtitle("Michaelis-Menten kinetics") +
  geom_point(alpha = 0.5) +
  geom_line(data = mml.dia, aes(x = sub, y = vel), colour = "red")
ggsave("mm_dia.pdf", width = 6, height = 4)
#collect slopes
#multiply by negative 1, multiple by a 1000, divide by 0.2
#x,y for mm

#all together plot
ggplot(mm.atrazine, aes(x = sub, y = vel)) +
  theme_bw() +
  xlab("Concentration [uM]") +
  ylab("Velocity [pmol/min/mg protein]") +
  ggtitle("Michaelis-Menten kinetics") +
  geom_point(alpha = 0.5) +
  geom_line(data = mml.atrazine, aes(x = sub, y = vel), colour = "red") +
  geom_line(data = mml.dea, aes(x = sub, y = vel), colour = "blue") +
  geom_line(data = mml.dia, aes(x = sub, y = vel), colour = "green")
ggsave("mm_atrazine+D.pdf", width = 6, height = 4)


```

triadimefon
=================================
```{r triadimefon_setup, eval=TRUE, echo=FALSE}
#microsome.atrazine.atrazine$microMexp
Substrate <- microsome.triadimefon.triadimefon$microMexp
Time <- microsome.triadimefon.triadimefon$time
Observed <- microsome.triadimefon.triadimefon$conc
if(verbose_output){
  scatterplot3d(Substrate, Time, Observed, highlight.3d = TRUE, col.grid = "lightblue", 
                col.axis = "blue")
}
```

The above figure shows a three-dimensional plot of pesticide substrate concentration, observed concentration and experiment time. We need to condition the pesticide data on the substrate concentrations used in the experiment and regress the observed concentrations over the 90 min period in order to estimate the linear slopes for the Michaelis-Menten kinetic rate constants.

```{r triadimefon_plots, eval=TRUE, echo=FALSE}
Substrates <- unique(Substrate)
n_substrates <- length(Substrates)
sub <- vector(mode = "numeric", length = n_substrates)
vel <- vector(mode = "numeric", length = n_substrates)
print("Substrates:")
i <- 0
for (s in Substrates){
  i <- i + 1
  if(verbose_output){
    print("##################################################")
    print(paste("Substrate = ", s))
  }
  ind <- which(Substrate==s)
  if(verbose_output){
    print(paste("Indices = ", ind))
    print(paste("Times =", Time[ind]))
    print(paste("Concs =", Observed[ind]))
  }
  mfit <- rlm(Observed[ind] ~ Time[ind])
  if(verbose_output){
    print(mfit)
    print(summary(mfit))
  }
  plot(Time[ind],Observed[ind], main = paste("Triadimefon Substrate =", s))
  text(Time[ind], Observed[ind], labels=ind, cex= 0.8, pos=4)
  abline(mfit)
  if(verbose_output){
    print(coefficients(mfit))
    print(confint(mfit))
  }
  sub[i] <- s
  vel[i] <- coefficients(mfit)[2] * (-1) * 1000 /0.2
  if(verbose_output){
    print("##################################################")
  }
}

mm.triadimefon <- as.data.frame(cbind(sub,vel))
if(verbose_output){
  str(mm.triadimefon)
  print(mm.triadimefon)
}

#plot(vel ~ sub)
model.triadimefon.drm <- drm(vel ~ sub, fct = MM.2())
print("here are the rates")
print(summary(model.triadimefon.drm))

#redo substrate concs for plotting
mml.triadimefon <- data.frame(sub = seq(0, max(sub), length.out = 100))
mml.triadimefon$vel <- predict(model.triadimefon.drm, newdata = mml.triadimefon)

ggplot(mm.triadimefon, aes(x = sub, y = vel)) +
  theme_bw() +
  xlab("Concentration [uM]") +
  ylab("Velocity [pmol/min/mg protein]") +
  ggtitle("Michaelis-Menten kinetics") +
  geom_point(alpha = 0.5) +
  geom_line(data = mml.triadimefon, aes(x = sub, y = vel), colour = "red")
ggsave("mm_triadimefon.pdf", width = 6, height = 4)
#collect slopes
#multiply by negative 1, multiple by a 1000, divide by 0.2
#x,y for mm
```

tdla
=================================
```{r tdla_setup, eval=TRUE, echo=FALSE}
#microsome.atrazine.atrazine$microMexp
Substrate <- microsome.triadimefon.tdla$microMexp
Time <- microsome.triadimefon.tdla$time
Observed <- microsome.triadimefon.tdla$conc
if(verbose_output){
  scatterplot3d(Substrate, Time, Observed, highlight.3d = TRUE, col.grid = "lightblue", 
                col.axis = "blue")
}
```

The above figure shows a three-dimensional plot of pesticide substrate concentration, observed concentration and experiment time. We need to condition the pesticide data on the substrate concentrations used in the experiment and regress the observed concentrations over the 90 min period in order to estimate the linear slopes for the Michaelis-Menten kinetic rate constants.

```{r tdla_plots, eval=TRUE, echo=FALSE}
Substrates <- unique(Substrate)
n_substrates <- length(Substrates)
sub <- vector(mode = "numeric", length = n_substrates)
vel <- vector(mode = "numeric", length = n_substrates)
print("Substrates:")
i <- 0
for (s in Substrates){
  i <- i + 1
  if(verbose_output){
    print("##################################################")
    print(paste("Substrate = ", s))
  }
  ind <- which(Substrate==s)
  if(verbose_output){
    print(paste("Indices = ", ind))
    print(paste("Times =", Time[ind]))
    print(paste("Concs =", Observed[ind]))
  }
  mfit <- rlm(Observed[ind] ~ Time[ind])
  if(verbose_output){
    print(mfit)
    print(summary(mfit))
  }
  plot(Time[ind],Observed[ind], main = paste("tdla Substrate =", s))
  text(Time[ind], Observed[ind], labels=ind, cex= 0.8, pos=4)
  abline(mfit)
  if(verbose_output){
    print(coefficients(mfit))
    print(confint(mfit))
  }
  sub[i] <- s
  vel[i] <- coefficients(mfit)[2] * 1000 /0.2
  if(verbose_output){
    print("##################################################")
  }
}

mm.tdla <- as.data.frame(cbind(sub,vel))
if(verbose_output){
  str(mm.tdla)
  print(mm.tdla)
}

#plot(vel ~ sub)
model.tdla.drm <- drm(vel ~ sub, fct = MM.2())
print("here are the rates")
print(summary(model.tdla.drm))

#redo substrate concs for plotting
mml.tdla <- data.frame(sub = seq(0, max(sub), length.out = 100))
mml.tdla$vel <- predict(model.tdla.drm, newdata = mml.tdla)

ggplot(mm.tdla, aes(x = sub, y = vel)) +
  theme_bw() +
  xlab("Concentration [uM]") +
  ylab("Velocity [pmol/min/mg protein]") +
  ggtitle("Michaelis-Menten kinetics") +
  geom_point(alpha = 0.5) +
  geom_line(data = mml.tdla, aes(x = sub, y = vel), colour = "red")
ggsave("mm_tdla.pdf", width = 6, height = 4)
#collect slopes
#multiply by negative 1, multiple by a 1000, divide by 0.2
#x,y for mm
```

tdlb
=================================
```{r tdlb_setup, eval=TRUE, echo=FALSE}
#microsome.atrazine.atrazine$microMexp
Substrate <- microsome.triadimefon.tdlb$microMexp
Time <- microsome.triadimefon.tdlb$time
Observed <- microsome.triadimefon.tdlb$conc
if(verbose_output){
  scatterplot3d(Substrate, Time, Observed, highlight.3d = TRUE, col.grid = "lightblue", 
                col.axis = "blue")
}
```

The above figure shows a three-dimensional plot of pesticide substrate concentration, observed concentration and experiment time. We need to condition the pesticide data on the substrate concentrations used in the experiment and regress the observed concentrations over the 90 min period in order to estimate the linear slopes for the Michaelis-Menten kinetic rate constants.

```{r tdlb_plots, eval=TRUE, echo=FALSE}
Substrates <- unique(Substrate)
n_substrates <- length(Substrates)
sub <- vector(mode = "numeric", length = n_substrates)
vel <- vector(mode = "numeric", length = n_substrates)
print("Substrates:")
i <- 0
for (s in Substrates){
  i <- i + 1
  if(verbose_output){
    print("##################################################")
    print(paste("Substrate = ", s))
  }
  ind <- which(Substrate==s)
  if(verbose_output){
    print(paste("Indices = ", ind))
    print(paste("Times =", Time[ind]))
    print(paste("Concs =", Observed[ind]))
  }
  mfit <- rlm(Observed[ind] ~ Time[ind])
  if(verbose_output){
    print(mfit)
    print(summary(mfit))
  }
  plot(Time[ind],Observed[ind], main = paste("tdlb Substrate =", s))
  text(Time[ind], Observed[ind], labels=ind, cex= 0.8, pos=4)
  abline(mfit)
  if(verbose_output){
    print(coefficients(mfit))
    print(confint(mfit))
  }
  sub[i] <- s
  vel[i] <- coefficients(mfit)[2] * 1000 /0.2
  if(verbose_output){
    print("##################################################")
  }
}

mm.tdlb <- as.data.frame(cbind(sub,vel))
if(verbose_output){
  str(mm.tdlb)
  print(mm.tdlb)
}

#plot(vel ~ sub)
model.tdlb.drm <- drm(vel ~ sub, fct = MM.2())
print("here are the rates")
print(summary(model.tdlb.drm))

#redo substrate concs for plotting
mml.tdlb <- data.frame(sub = seq(0, max(sub), length.out = 100))
mml.tdlb$vel <- predict(model.tdlb.drm, newdata = mml.tdlb)

ggplot(mm.tdlb, aes(x = sub, y = vel)) +
  theme_bw() +
  xlab("Concentration [uM]") +
  ylab("Velocity [pmol/min/mg protein]") +
  ggtitle("Michaelis-Menten kinetics") +
  geom_point(alpha = 0.5) +
  geom_line(data = mml.tdlb, aes(x = sub, y = vel), colour = "red")
ggsave("mm_tdlb.pdf", width = 6, height = 4)
#collect slopes
#multiply by negative 1, multiple by a 1000, divide by 0.2
#x,y for mm

#all together
ggplot(mm.triadimefon, aes(x = sub, y = vel)) +
  theme_bw() +
  xlab("Concentration [uM]") +
  ylab("Velocity [pmol/min/mg protein]") +
  ggtitle("Michaelis-Menten kinetics") +
  geom_point(alpha = 0.5) +
  geom_line(data = mml.triadimefon, aes(x = sub, y = vel), colour = "red") +
  geom_line(data = mml.tdla, aes(x = sub, y = vel), colour = "blue") +
  geom_line(data = mml.tdlb, aes(x = sub, y = vel), colour = "green")
ggsave("mm_triadimefon+D.pdf", width = 6, height = 4)

```

fipronil
=================================
```{r fipronil_setup, eval=TRUE, echo=FALSE}
#microsome.atrazine.atrazine$microMexp
Substrate <- microsome.fipronil.fipronil$microMexp
Time <- microsome.fipronil.fipronil$time
Observed <- microsome.fipronil.fipronil$conc
if(verbose_output){
  scatterplot3d(Substrate, Time, Observed, highlight.3d = TRUE, col.grid = "lightblue", 
                col.axis = "blue")
}
```

The above figure shows a three-dimensional plot of pesticide substrate concentration, observed concentration and experiment time. We need to condition the pesticide data on the substrate concentrations used in the experiment and regress the observed concentrations over the 90 min period in order to estimate the linear slopes for the Michaelis-Menten kinetic rate constants.

```{r fipronil_plots, eval=TRUE, echo=FALSE}
Substrates <- unique(Substrate)
n_substrates <- length(Substrates)
sub <- vector(mode = "numeric", length = n_substrates)
vel <- vector(mode = "numeric", length = n_substrates)
print("Substrates:")
i <- 0
for (s in Substrates){
  i <- i + 1
  if(verbose_output){
    print("##################################################")
    print(paste("Substrate = ", s))
  }
  ind <- which(Substrate==s)
  if(verbose_output){
    print(paste("Indices = ", ind))
    print(paste("Times =", Time[ind]))
    print(paste("Concs =", Observed[ind]))
  }
  mfit <- rlm(Observed[ind] ~ Time[ind])
  if(verbose_output){
    print(mfit)
    print(summary(mfit))
  }
  plot(Time[ind],Observed[ind], main = paste("Fipronil Substrate =", s))
  text(Time[ind], Observed[ind], labels=ind, cex= 0.8, pos=4)
  abline(mfit)
  if(verbose_output){
    print(coefficients(mfit))
    print(confint(mfit))
  }
  sub[i] <- s
  vel[i] <- coefficients(mfit)[2] * (-1) * 1000 /0.2
  if(verbose_output){
    print("##################################################")
  }
}

mm.fipronil <- as.data.frame(cbind(sub,vel))
if(verbose_output){
  str(mm.fipronil)
  print(mm.fipronil)
}

#plot(vel ~ sub)
model.fipronil.drm <- drm(vel ~ sub, fct = MM.2())
print("here are the rates")
print(summary(model.fipronil.drm))

#redo substrate concs for plotting
mml.fipronil <- data.frame(sub = seq(0, max(sub), length.out = 100))
mml.fipronil$vel <- predict(model.fipronil.drm, newdata = mml.fipronil)

ggplot(mm.fipronil, aes(x = sub, y = vel)) +
  theme_bw() +
  xlab("Concentration [uM]") +
  ylab("Velocity [pmol/min/mg protein]") +
  ggtitle("Michaelis-Menten kinetics") +
  geom_point(alpha = 0.5) +
  geom_line(data = mml.fipronil, aes(x = sub, y = vel), colour = "red")
ggsave("mm_fipronil.pdf", width = 6, height = 4)
#collect slopes
#multiply by negative 1, multiple by a 1000, divide by 0.2
#x,y for mm
```

fipsulf
=================================
```{r fipsulf_setup, eval=TRUE, echo=FALSE}
#microsome.atrazine.atrazine$microMexp
Substrate <- microsome.fipronil.fipsulf$microMexp
Time <- microsome.fipronil.fipsulf$time
Observed <- microsome.fipronil.fipsulf$conc
if(verbose_output){
  scatterplot3d(Substrate, Time, Observed, highlight.3d = TRUE, col.grid = "lightblue", 
                col.axis = "blue")
}
```

The above figure shows a three-dimensional plot of pesticide substrate concentration, observed concentration and experiment time. We need to condition the pesticide data on the substrate concentrations used in the experiment and regress the observed concentrations over the 90 min period in order to estimate the linear slopes for the Michaelis-Menten kinetic rate constants.

```{r fipsulf_plots, eval=TRUE, echo=FALSE}
Substrates <- unique(Substrate)
n_substrates <- length(Substrates)
sub <- vector(mode = "numeric", length = n_substrates)
vel <- vector(mode = "numeric", length = n_substrates)
print("Substrates:")
i <- 0
for (s in Substrates){
  i <- i + 1
  if(verbose_output){
    print("##################################################")
    print(paste("Substrate = ", s))
  }
  ind <- which(Substrate==s)
  if(verbose_output){
    print(paste("Indices = ", ind))
    print(paste("Times =", Time[ind]))
    print(paste("Concs =", Observed[ind]))
  }
  mfit <- rlm(Observed[ind] ~ Time[ind])
  if(verbose_output){
    print(mfit)
    print(summary(mfit))
  }
  plot(Time[ind],Observed[ind], main = paste("fipsulf Substrate =", s))
  text(Time[ind], Observed[ind], labels=ind, cex= 0.8, pos=4)
  abline(mfit)
  if(verbose_output){
    print(coefficients(mfit))
    print(confint(mfit))
  }
  sub[i] <- s
  vel[i] <- coefficients(mfit)[2] * 1000 /0.2
  if(verbose_output){
    print("##################################################")
  }
}

mm.fipsulf <- as.data.frame(cbind(sub,vel))
if(verbose_output){
  str(mm.fipsulf)
  print(mm.fipsulf)
}

#plot(vel ~ sub)
model.fipsulf.drm <- drm(vel ~ sub, fct = MM.2())
print("here are the rates")
print(summary(model.fipsulf.drm))

#redo substrate concs for plotting
mml.fipsulf <- data.frame(sub = seq(0, max(sub), length.out = 100))
mml.fipsulf$vel <- predict(model.fipsulf.drm, newdata = mml.fipsulf)

ggplot(mm.fipsulf, aes(x = sub, y = vel)) +
  theme_bw() +
  xlab("Concentration [uM]") +
  ylab("Velocity [pmol/min/mg protein]") +
  ggtitle("Michaelis-Menten kinetics") +
  geom_point(alpha = 0.5) +
  geom_line(data = mml.fipsulf, aes(x = sub, y = vel), colour = "red")
ggsave("mm_fipsulf.pdf", width = 6, height = 4)
#collect slopes
#multiply by negative 1, multiple by a 1000, divide by 0.2
#x,y for mm

ggplot(mm.fipronil, aes(x = sub, y = vel)) +
  theme_bw() +
  xlab("Concentration [uM]") +
  ylab("Velocity [pmol/min/mg protein]") +
  ggtitle("Michaelis-Menten kinetics") +
  geom_point(alpha = 0.5) +
  geom_line(data = mml.fipronil, aes(x = sub, y = vel), colour = "red") +
  geom_line(data = mml.fipsulf, aes(x = sub, y = vel), colour = "blue")
ggsave("mm_fipronil+D.pdf", width = 6, height = 4)

```

exposure experiment analysis
============================
Results presentation and discussion for parent analytes (atrazine, triadimenon, and fipronil) and their xenobiotic metabolites.

Toxicity of parents and metabolites discussion.

Microsomal analysis of soil and amphibian data for 0 (soil only), 2, 4, 12, 24, and 48 hours after exposure.

Database has factors for time, parent (mapped to analyte), analyte (can be either parent or metabolite), matrix (amphibian or soil), and tank (potentially a nuisance variable).

```{r eval=TRUE, echo=FALSE}
#using dplyr
micro.group <- group_by(micro, parent, analyte, matrix, time)
str(micro.group)
micro.group
micro.group.stats <- summarise(micro.group, 
            count = n(),
            ConcMean = mean(conc),
            ConcSD = sd(conc)
)

micro.group.stats
micro.group.stats.html <- print.xtable(xtable(micro.group.stats), type="html")
dput(micro.group.stats.html, file = paste(micro.tables,"micro.group.stats.html"
                                          ,sep=""))
#View(micro.group.stats)
```

The amphibian data set summary statistics. Atrazine peaks at 4 hours and then declines monotonically. DEA peaks at 12 hours and DIA at 24. Fipronil steadily declines from its first observation at 2 hours with fipronil sulfone not peaking until 24 hours. Triadimenon peaks at 24 hours with its metabolites tdla and tdlb peaking at 4 hours.

```{r eval=TRUE, echo=FALSE}
str(micro.group.stats)
micro.group.stats.amphib <- micro.group.stats[which(micro.group.stats$matrix=="amphib"),]
head(micro.group.stats.amphib)
#atrazine
micro.group.stats.amphib.atrazine <- micro.group.stats.amphib[which(micro.group.stats.amphib$parent=="atrazine"),]
micro.group.stats.amphib.atrazine
atrazine.analytes <- unique(micro.group.stats.amphib.atrazine$analyte)
for(analyte in atrazine.analytes){
  print(analyte)
}

#fipronil
micro.group.stats.amphib.fipronil <- micro.group.stats.amphib[which(micro.group.stats.amphib$parent=="fipronil"),]
micro.group.stats.amphib.fipronil
#triadimenon
micro.group.stats.amphib.triadimenon <- micro.group.stats.amphib[which(micro.group.stats.amphib$parent=="triadimenon"),]
micro.group.stats.amphib.triadimenon
```

```{r eval=TRUE, echo=FALSE}
#plot with zoo objects
```

The soil data set summary statistics. Atrazine in soil showing an upwards trend (need to test if significant) with dia and dea levels very low indicating little degradation in soil over the 48 hour period. Fipronil and triadimenon data also indicating little degradation in soil. 

```{r eval=TRUE, echo=FALSE}
micro.group.stats.soil <- micro.group.stats[which(micro.group.stats$matrix=="soil"),]
#atrazine
micro.group.stats.soil.atrazine <- micro.group.stats.soil[which(micro.group.stats.soil$parent=="atrazine"),]
micro.group.stats.soil.atrazine
#fipronil
micro.group.stats.soil.fipronil <- micro.group.stats.soil[which(micro.group.stats.soil$parent=="fipronil"),]
micro.group.stats.soil.fipronil
#triadimenon
micro.group.stats.soil.triadimenon <- micro.group.stats.soil[which(micro.group.stats.soil$parent=="triadimenon"),]
micro.group.stats.soil.triadimenon
```



```{r eval=TRUE, echo=TRUE}
pdf(paste(micro.graphics,"data_mean_scatterplot",".pdf", sep=""))
  par(mfrow=c(3,1))
  print(parents)
  for(parent in parents){
    i=0
    print(parent)
    temp.parent <- micro.group.stats.amphib[which(micro.group.stats.amphib$parent==parent),]
    print(temp.parent)
    parent.analytes <- unique(temp.parent$analyte)
    for(analyte in parent.analytes){
      print(parent)
      print(analyte) 
      analytetemp <- micro.group.stats.amphib[which(micro.group.stats.amphib$analyte==analyte),]
      xvalues <- as.numeric(as.character(analytetemp$time))
      points.y <- micro.amphib[which(micro.amphib$analyte==analyte),]$conc
      points.x <- as.numeric(as.character(micro.amphib[which(micro.amphib$analyte==analyte),]$time))
      #create empty plot if needed
      if(i==0){
        parenttemp <- micro.group.stats.amphib[which(micro.group.stats.amphib$parent==parent),]
        maxconc <- max(points.y) 
        plot(xvalues,analytetemp$ConcMean,type="l", xlim=c(0,48),
             ylim = c(0,maxconc), main=parent,col="black", xlab="Hours", ylab="Concentration")
        axis(1,at=xvalues)
        i=1
      }
      #add line for parent metabolite
      if(analyte %in% parents){
        lines(xvalues,analytetemp$ConcMean,type="l",col="red")
        points(points.x, points.y, col = "red")
      }else{
      #add line for daughter metabolite
        lines(xvalues,analytetemp$ConcMean,type="l",col="blue")
        points(points.x, points.y, col = "blue")
      }
    }
  }
dev.off()
```

la de da

#turn times series to zoo objects



#estimate lambdas using maximum likelihood for each time series
library(maxLik)

MLexp <- function(times, data){
  
  expLik <- function(param) {
    y <- data
    t <- times
    alpha1 <- param[1]
    lambda1 <- param[2]-1*(alpha1-lambda1*t) - y/(exp(alpha1-lambda1*t))
  }
  
  max.fit <- maxLik(expLik, start = c(1,1))
  crit <- qt(.975, length(data)-2)
  max.intercept.CI <- c(summary(max.fit)$est[1,1]-crit*summary(max.fit)$est[1,2],summary(max.fit)$est[1,1]+crit*summary(max.fit)$est[1,2])
  max.decayrate.CI <- c(-1*summary(max.fit)$est[2,1]-crit*summary(max.fit)$est[2,2],-1*summary(max.fit)$est[2,1]+crit*summary(max.fit)$est[2,2])
  max.halflife.CI <- c(log(2)/max.decayrate.CI[2],log(2)/max.decayrate.CI[1])
  
  paste("MLE for Initial Concentration =",max.fit$est[1],
        "MLE for decay rate =", max.fit$est[2],
        "MLE for half life =", -log(.5)/max.fit$est[2])
  
  temp.list <- list(max.fit$est[1],  max.fit$est[2], -log(.5)/max.fit$est[2], max.intercept.CI, max.decayrate.CI, max.halflife.CI, vcov(max.fit) )
  return(temp.list)
}

MLexp.intercept <- function(times, data) {
  temp.fit <- MLexp(times,data)
  temp.fit[[1]]
}

MLexp.decayrate <- function(times, data) {
  temp.fit <- MLexp(times,data)
  temp.fit[[2]]
}

MLexp.halflife <- function(times,data) {
  temp.fit <- MLexp(times,data)
  temp.fit[[3]]
}

MLexp.intercept.CI <- function(times,data){
  temp.fit <- MLexp(times,data)
  temp2 <- temp.fit[[4]]
  names(temp2) <- c("Lower95", "Upper95")
  temp2
}

MLexp.decayrate.CI <- function(times,data){
  temp.fit <- MLexp(times,data)
  temp2 <- temp.fit[[5]]
  names(temp2) <- c("Lower95", "Upper95")
  temp2
}

MLexp.halflife.CI <- function(times,data){
  temp.fit <- MLexp(times,data)
  temp2 <- temp.fit[[6]]
  names(temp2) <- c("Lower95", "Upper95")
  temp2
}

microsome experiment analysis
============================
data in csv format